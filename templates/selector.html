<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Illustrator - å›¾ç‰‡é€‰æ‹©å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .candidate-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .candidate-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .candidate-card.selected {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .markdown-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 4;
        }
        .markdown-preview {
            line-height: 1.8;
        }
        .markdown-preview img {
            max-width: 50%;
            border-radius: 8px;
            margin: 10px 0;
        }
        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }
        .markdown-preview code {
            background: #1e293b;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .markdown-preview pre {
            background: #1e293b;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
        }
        .markdown-preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
        }
        .markdown-preview table th,
        .markdown-preview table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }
        .markdown-preview table th {
            background: #374151;
            font-weight: 600;
        }
        .markdown-preview table tr:last-child td {
            border-bottom: none;
        }
        .markdown-preview table tr:hover {
            background: #2d3748;
        }
        .markdown-preview blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
            margin: 16px 0;
            color: #9ca3af;
            font-style: italic;
        }
        .markdown-preview ul,
        .markdown-preview ol {
            margin: 16px 0;
            padding-left: 24px;
        }
        .markdown-preview li {
            margin: 8px 0;
        }
        .split-pane {
            display: flex;
            height: calc(100vh - 200px);
        }
        .editor-pane {
            flex: 1;
            overflow: auto;
        }
        .candidates-pane {
            width: 400px;
            overflow-y: auto;
            border-left: 1px solid #374151;
        }
        .tab-button {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- å¤´éƒ¨ -->
        <header class="mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-blue-400">MarkDownè‡ªåŠ¨é…å›¾</h1>
                    <p class="text-gray-400 text-sm mt-1" id="file-info">åŠ è½½ä¸­...</p>
                    <!-- å›¾ç‰‡æ¥æºé€‰æ‹©å™¨ -->
                    <div class="flex items-center gap-2 mt-2">
                        <label class="text-gray-400 text-sm">å›¾ç‰‡æ¥æº:</label>
                        <select id="image-source-select" class="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-gray-300 focus:border-blue-500 focus:outline-none">
                            <option value="auto">auto - æ™ºèƒ½é€‰æ‹©</option>
                            <option value="zhipu">zhipu - æ™ºè°±AI</option>
                            <option value="doubao">doubao - è±†åŒ…</option>
                            <option value="flux">flux - Flux.1</option>
                            <option value="dalle">dalle - DALL-E 3</option>
                            <option value="unsplash">unsplash - å…è´¹å›¾åº“</option>
                            <option value="pexels">pexels - å…è´¹å›¾åº“</option>
                            <option value="mermaid">mermaid - æŠ€æœ¯å›¾è¡¨</option>
                        </select>
                        <span class="text-gray-500 text-xs" id="source-hint">æŠ€æœ¯æ–‡æ¡£è‡ªåŠ¨é€‰Mermaidï¼Œæ™®é€šæ–‡æ¡£ä½¿ç”¨å›¾åº“+AIé™çº§</span>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="illustrateMarkdown()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm" id="illustrate-btn">
                        å¼€å§‹é…å›¾
                    </button>
                    <button onclick="selectAllBest()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
                        å…¨é€‰ç¬¬ä¸€å¼ 
                    </button>
                    <button onclick="saveContent()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                        ä¿å­˜ä¿®æ”¹
                    </button>
                    <button onclick="exportMarkdown()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">
                        å¯¼å‡º Markdown
                    </button>
                    <button onclick="toggleHelp()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm" title="ä½¿ç”¨å¸®åŠ©">
                        â“ å¸®åŠ©
                    </button>
                </div>

                <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ³¨é”€ -->
                <div class="flex items-center gap-3 ml-4 pl-4 border-l border-gray-700">
                    <div class="text-right">
                        <div class="text-sm text-gray-300" id="user-name">åŠ è½½ä¸­...</div>
                        <div class="text-xs text-gray-500" id="user-quota">--/--</div>
                    </div>
                    <button onclick="logout()" class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm" title="é€€å‡ºç™»å½•">
                        é€€å‡º
                    </button>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="flex gap-4 mt-4 border-b border-gray-700">
                <div class="tab-button active" onclick="switchTab('preview')" id="tab-preview">
                    é¢„è§ˆæ¨¡å¼
                </div>
                <div class="tab-button" onclick="switchTab('edit')" id="tab-edit">
                    ç¼–è¾‘æ¨¡å¼
                </div>
                <div class="tab-button" onclick="switchTab('candidates')" id="tab-candidates">
                    å€™é€‰å›¾ç®¡ç†
                </div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <div id="preview-mode" class="mode-content">
            <div class="split-pane">
                <!-- Markdown é¢„è§ˆ -->
                <div class="editor-pane p-4">
                    <div id="markdown-preview" class="markdown-preview prose prose-invert max-w-none">
                        åŠ è½½ä¸­...
                    </div>
                </div>

                <!-- å½“å‰ä½ç½®çš„å€™é€‰å›¾ -->
                <div class="candidates-pane p-4">
                    <h3 class="text-lg font-semibold mb-4">å€™é€‰å›¾é€‰æ‹©</h3>
                    <div id="current-candidates" class="space-y-4">
                        <p class="text-gray-400 text-sm">ç‚¹å‡»é¢„è§ˆä¸­çš„å›¾ç‰‡æŸ¥çœ‹å€™é€‰å›¾</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ¨¡å¼ -->
        <div id="edit-mode" class="mode-content hidden">
            <div class="split-pane">
                <textarea
                    id="markdown-editor"
                    class="editor-pane w-full p-4 bg-gray-800 text-gray-100 resize-none outline-none"
                    placeholder="Markdown å†…å®¹..."
                    oninput="onEditorChange()"
                ></textarea>
            </div>
        </div>

        <!-- å€™é€‰å›¾ç®¡ç†æ¨¡å¼ -->
        <div id="candidates-mode" class="mode-content hidden">
            <div id="all-candidates-container" class="space-y-6">
                <p class="text-gray-400">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <footer class="mt-4 p-4 bg-gray-800 rounded-lg">
            <div class="flex items-center justify-between text-sm text-gray-400">
                <div id="status-info">
                    å·²é€‰æ‹©: <span id="selected-count">0</span> / <span id="total-count">0</span> ä¸ªä½ç½®
                </div>
                <div id="save-status" class="text-green-400 hidden">
                    âœ“ å·²ä¿å­˜
                </div>
            </div>
        </footer>
    </div>

    <script>
        let markdownContent = '';
        let originalContent = '';
        let candidates = [];
        let selections = {};
        let imagePositions = []; // å­˜å‚¨å›¾ç‰‡åœ¨ Markdown ä¸­çš„ä½ç½®

        // å›¾ç‰‡æ¥æºæç¤ºæ–‡æœ¬æ˜ å°„
        const sourceHints = {
            'auto': 'æŠ€æœ¯æ–‡æ¡£è‡ªåŠ¨é€‰Mermaidï¼Œæ™®é€šæ–‡æ¡£ä½¿ç”¨å›¾åº“+AIé™çº§',
            'zhipu': 'æ™ºè°±AI CogView (0.06å…ƒ/å¼ , ä¸­æ–‡æ•ˆæœå¥½)',
            'doubao': 'è±†åŒ…æ–‡ç”Ÿå›¾ (0.005å…ƒ/å¼ , è¶…ä¾¿å®œ)',
            'flux': 'Flux.1 (0.01å…ƒ/å¼ , è´¨é‡æ¥è¿‘Midjourney)',
            'dalle': 'OpenAI DALL-E 3 (~0.4å…ƒ/å¼ , è´¨é‡æœ€å¥½)',
            'unsplash': 'Unsplash å…è´¹å›¾åº“ (çœŸå®ç…§ç‰‡)',
            'pexels': 'Pexels å…è´¹å›¾åº“ (çœŸå®ç…§ç‰‡)',
            'mermaid': 'Mermaid å›¾è¡¨ (å®Œå…¨å…è´¹, æŠ€æœ¯å›¾è¡¨)'
        };

        // å›¾ç‰‡æ¥æºé€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
        function updateSourceHint() {
            const select = document.getElementById('image-source-select');
            const hint = document.getElementById('source-hint');
            hint.textContent = sourceHints[select.value] || '';
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.onload = async function() {
            // ç»‘å®šå›¾ç‰‡æ¥æºé€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('image-source-select').addEventListener('change', updateSourceHint);
            updateSourceHint(); // åˆå§‹åŒ–æç¤ºæ–‡æœ¬

            // é…ç½® marked.js
            marked.use({
                gfm: true,          // GitHub Flavored Markdown
                breaks: true,       // æ”¯æŒæ¢è¡Œ
                tables: true,       // æ”¯æŒè¡¨æ ¼
                pedantic: false,
                sanitize: false,
                smartLists: true,
                smartypants: false
            });

            // åˆå§‹åŒ– Mermaid
            mermaid.initialize({
                startOnLoad: false,
                theme: 'dark',
                securityLevel: 'loose',
                themeVariables: {
                    darkMode: true,
                    background: '#1e293b',
                    primaryColor: '#3b82f6',
                    primaryTextColor: '#e2e8f0',
                    primaryBorderColor: '#475569',
                    lineColor: '#64748b',
                    secondaryColor: '#64748b',
                    tertiaryColor: '#475569',
                    fontSize: '16px'
                },
                sequence: {
                    actorMargin: 50,
                    boxMargin: 10,
                    boxTextMargin: 5,
                    noteMargin: 10,
                    messageMargin: 35
                }
            });

            await loadUserInfo();
            await loadMarkdown();
            await loadCandidates();
            renderMarkdown();
            switchTab('preview');
        };

        async function loadMarkdown() {
            try {
                const response = await fetch('/api/markdown');
                const data = await response.json();
                markdownContent = data.content;
                originalContent = data.content;
                document.getElementById('file-info').textContent = data.path;
                document.getElementById('markdown-editor').value = data.content;
            } catch (error) {
                showError('åŠ è½½ Markdown å¤±è´¥: ' + error.message);
            }
        }

        async function loadCandidates() {
            try {
                const response = await fetch('/api/candidates');
                const data = await response.json();
                candidates = data.candidates;

                // åˆå§‹åŒ–é€‰æ‹©
                candidates.forEach(pos => {
                    for (let cand of pos.candidates) {
                        if (cand.is_selected) {
                            selections[pos.index] = cand.index;
                            break;
                        }
                    }
                    if (selections[pos.index] === undefined && pos.candidates.length > 0) {
                        selections[pos.index] = 0;
                    }
                });

                updateCounts();
            } catch (error) {
                console.error('åŠ è½½å€™é€‰å›¾å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/me');
                if (response.status === 401) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                const user = data.user;
                document.getElementById('user-name').textContent = `${user.name} (${user.username})`;
                document.getElementById('user-quota').textContent = `ä»Šæ—¥é…é¢: ${user.used_today}/${user.quota_limit}`;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ³¨é”€
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }
            try {
                const response = await fetch('/logout', {
                    method: 'GET',
                    redirect: 'follow'
                });
                // æœåŠ¡å™¨ä¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('æ³¨é”€å¤±è´¥:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = '/login';
            }
        }

        function renderMarkdown() {
            // è§£æ Markdownï¼Œæå–å›¾ç‰‡ä½ç½®å¹¶æ·»åŠ å¯ç‚¹å‡»æ ‡è®°
            const lines = markdownContent.split('\n');
            let renderedLines = [];
            let mermaidPlaceholders = []; // å­˜å‚¨ mermaid å ä½ç¬¦å’Œå¯¹åº”çš„ HTML
            imagePositions = [];
            let imageIndex = 0;
            let inCodeBlock = false;
            let codeBlockLines = [];
            let codeBlockLang = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // å¤„ç†ä»£ç å—
                if (line.trim().startsWith('```')) {
                    if (!inCodeBlock) {
                        // ä»£ç å—å¼€å§‹
                        inCodeBlock = true;
                        codeBlockLang = line.trim().substring(3).trim() || 'text';
                        codeBlockLines = [];
                    } else {
                        // ä»£ç å—ç»“æŸ
                        inCodeBlock = false;

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ mermaid ä»£ç å—
                        if (codeBlockLang.toLowerCase() === 'mermaid' || (codeBlockLang === '' && hasMermaidKeywords(codeBlockLines))) {
                            // è¿™æ˜¯ä¸€ä¸ª Mermaid å›¾è¡¨ï¼Œä½¿ç”¨å ä½ç¬¦
                            const mermaidCode = codeBlockLines.join('\n');
                            const placeholderIndex = mermaidPlaceholders.length;
                            const containerId = `mermaid-${Date.now()}-${imageIndex}`;
                            const mermaidHtml = `<div class="mermaid-container my-4 p-4 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700" onclick="showCandidatesForMermaid('${containerId}')"><div class="mermaid" id="${containerId}">${mermaidCode}</div><p class="text-xs text-gray-400 mt-2 text-center">ç‚¹å‡»æŸ¥çœ‹å€™é€‰å›¾</p></div>`;
                            const placeholder = `[[[MERMAID_${placeholderIndex}]]]`;
                            mermaidPlaceholders.push({ placeholder: placeholder, html: mermaidHtml });
                            renderedLines.push(placeholder);
                        } else {
                            // æ™®é€šä»£ç å—
                            renderedLines.push('```' + codeBlockLang);
                            renderedLines.push(...codeBlockLines);
                            renderedLines.push('```');
                        }
                        codeBlockLines = [];
                    }
                    continue;
                }

                if (inCodeBlock) {
                    codeBlockLines.push(line);
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡è¡Œ
                const imgMatch = line.match(/^!\[([^\]]+)\]\(([^)]+)\)(.*)$/);
                if (imgMatch && !line.trim().startsWith('<!--')) {
                    const altText = imgMatch[1];
                    const imgPath = imgMatch[2];
                    const suffix = imgMatch[3];

                    // æ‰¾åˆ°å¯¹åº”çš„å€™é€‰å›¾ä½ç½®
                    const posData = findPositionByPath(imgPath);

                    if (posData && posData.candidates.length > 1) {
                        // è¿™æ˜¯ä¸€ä¸ªæœ‰å¤šä¸ªå€™é€‰å›¾çš„ä½ç½®
                        imagePositions.push({
                            index: imageIndex,
                            line: i,
                            positionIndex: posData.index,
                            altText: altText
                        });

                        // ä½¿ç”¨å ä½ç¬¦
                        const placeholderIndex = mermaidPlaceholders.length;
                        let imgHtml;
                        if (imgPath.startsWith('MERMAID_CODE:')) {
                            const mermaidCode = extractMermaidCode(imgPath);
                            const containerId = `mermaid-img-${imageIndex}`;
                            imgHtml = `<div class="image-container my-4" data-image-index="${imageIndex}" onclick="showCandidates(${posData.index})"><div class="mermaid-container my-4 p-4 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700"><div class="mermaid" id="${containerId}">${mermaidCode}</div></div><p class="text-sm text-blue-400 mt-1">ğŸ“Š ç‚¹å‡»æŸ¥çœ‹ ${posData.candidates.length} ä¸ªå€™é€‰å›¾ (å½“å‰: å€™é€‰ ${(selections[posData.index] || 0) + 1})</p></div>`;
                        } else {
                            imgHtml = `<div class="image-container my-4" data-image-index="${imageIndex}" onclick="showCandidates(${posData.index})"><img src="${imgPath}" alt="${altText}" class="cursor-pointer hover:opacity-80" data-image-index="${imageIndex}"><p class="text-sm text-blue-400 mt-1">ğŸ“Š ç‚¹å‡»æŸ¥çœ‹ ${posData.candidates.length} ä¸ªå€™é€‰å›¾ (å½“å‰: å€™é€‰ ${(selections[posData.index] || 0) + 1})</p></div>`;
                        }
                        const placeholder = `[[[MERMAID_${placeholderIndex}]]]`;
                        mermaidPlaceholders.push({ placeholder: placeholder, html: imgHtml });
                        renderedLines.push(placeholder);
                        imageIndex++;
                    } else {
                        // æ™®é€šå›¾ç‰‡ï¼Œç›´æ¥æ¸²æŸ“
                        if (imgPath.startsWith('MERMAID_CODE:')) {
                            const mermaidCode = extractMermaidCode(imgPath);
                            const placeholderIndex = mermaidPlaceholders.length;
                            const containerId = `mermaid-static-${imageIndex}`;
                            const mermaidHtml = `<div class="my-4"><div class="mermaid" id="${containerId}">${mermaidCode}</div></div>`;
                            const placeholder = `[[[MERMAID_${placeholderIndex}]]]`;
                            mermaidPlaceholders.push({ placeholder: placeholder, html: mermaidHtml });
                            renderedLines.push(placeholder);
                        } else {
                            renderedLines.push(`<img src="${imgPath}" alt="${altText}">`);
                        }
                    }
                } else {
                    renderedLines.push(line);
                }
            }

            // ä½¿ç”¨ marked æ¸²æŸ“ Markdown
            const markdownText = renderedLines.join('\n');
            let renderedHtml = marked.parse(markdownText);

            // æ›¿æ¢å ä½ç¬¦ä¸ºå®é™…çš„ HTMLï¼ˆä½¿ç”¨ replaceAll ç¡®ä¿å…¨éƒ¨æ›¿æ¢ï¼‰
            for (const item of mermaidPlaceholders) {
                renderedHtml = renderedHtml.replaceAll(item.placeholder, item.html);
            }

            document.getElementById('markdown-preview').innerHTML = renderedHtml;

            // æ¸²æŸ“æ‰€æœ‰ Mermaid å›¾è¡¨
            renderAllMermaidDiagrams();
        }

        function hasMermaidKeywords(lines) {
            const keywords = [
                'stateDiagram', 'stateDiagram-v2',
                'sequenceDiagram',
                'flowchart', 'graph',
                'classDiagram',
                'erDiagram', 'er',
                'mindmap',
                'gantt',
                'pie', 'gitGraph'
            ];
            const text = lines.join('\n');
            return keywords.some(kw => text.toLowerCase().includes(kw.toLowerCase()));
        }

        async function renderAllMermaidDiagrams() {
            const mermaidDivs = document.querySelectorAll('#markdown-preview .mermaid');
            console.log(`æ‰¾åˆ° ${mermaidDivs.length} ä¸ª Mermaid å›¾è¡¨`);

            for (const div of mermaidDivs) {
                try {
                    const code = div.textContent;
                    console.log(`æ¸²æŸ“ Mermaid ä»£ç :`, code.substring(0, 50) + '...');
                    const uniqueId = 'mermaid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    const { svg } = await mermaid.render(uniqueId, code);
                    div.innerHTML = svg;
                    // ç§»é™¤èƒŒæ™¯è‰²ï¼Œè®©å›¾è¡¨é€æ˜
                    const svgElement = div.querySelector('svg');
                    if (svgElement) {
                        svgElement.style.background = 'transparent';
                        svgElement.style.maxWidth = '100%';
                        svgElement.style.height = 'auto';
                    }
                    console.log(`âœ“ Mermaid æ¸²æŸ“æˆåŠŸ: ${uniqueId}`);
                } catch (error) {
                    console.error('âœ— Mermaid æ¸²æŸ“å¤±è´¥:', error);
                    console.error('é—®é¢˜ä»£ç :', div.textContent);
                    div.innerHTML = `<pre class="text-red-400 p-2">Mermaid æ¸²æŸ“å¤±è´¥:\n${error.message}\n\nä»£ç :\n${div.textContent}</pre>`;
                }
            }
        }

        function showCandidatesForMermaid(containerId) {
            // æ‰¾åˆ°å¯¹åº”ä½ç½®çš„å€™é€‰å›¾
            const container = document.getElementById(containerId);
            if (!container) return;

            // ä» DOM ä¸­æŸ¥æ‰¾å¯¹åº”çš„å›¾ç‰‡ä½ç½®
            const imageContainer = container.closest('.image-container');
            if (imageContainer) {
                const imageIndex = parseInt(imageContainer.dataset.imageIndex);
                const imageData = imagePositions.find(ip => ip.index === imageIndex);
                if (imageData) {
                    showCandidates(imageData.positionIndex);
                }
            }
        }

        function extractMermaidCode(path) {
            // ä» MERMAID_CODE:type:code ä¸­æå–ä»£ç 
            const parts = path.split(':');
            if (parts.length >= 3) {
                return parts.slice(2).join(':').replace(/\\n/g, '\n');
            }
            return '';
        }

        function findPositionByPath(path) {
            for (let pos of candidates) {
                for (let cand of pos.candidates) {
                    if (cand.path === path) {
                        return pos;
                    }
                }
            }
            return null;
        }

        function showCandidates(positionIndex) {
            const pos = candidates.find(p => p.index === positionIndex);
            if (!pos) return;

            const container = document.getElementById('current-candidates');

            let html = `
                <div class="mb-4">
                    <h4 class="font-semibold text-blue-300">ä½ç½® ${positionIndex + 1}: ${getTypeName(pos.image_type)}</h4>
                    ${pos.prompt ? `<p class="text-xs text-gray-400 mt-1">${pos.prompt.substring(0, 100)}...</p>` : ''}
                </div>
                <div class="grid grid-cols-2 gap-3">
            `;

            pos.candidates.forEach((cand, idx) => {
                const isSelected = selections[positionIndex] === idx;
                const preview = getImagePreview(cand.path);

                html += `
                    <div
                        class="candidate-card rounded-lg overflow-hidden bg-gray-800 ${isSelected ? 'selected' : ''}"
                        onclick="selectCandidate(${positionIndex}, ${idx})"
                    >
                        <div class="aspect-square bg-gray-700 flex items-center justify-center p-2">
                            ${preview}
                        </div>
                        <div class="p-2 text-center text-xs">
                            <span class="text-gray-400">å€™é€‰ ${idx + 1}</span>
                            ${isSelected ? '<span class="ml-2 text-blue-400">âœ“</span>' : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            container.innerHTML = html;

            // æ»šåŠ¨åˆ°é¢„è§ˆä¸­çš„å¯¹åº”å›¾ç‰‡
            const imgContainer = document.querySelector(`[data-image-index="${positionIndex}"]`);
            if (imgContainer) {
                imgContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function getImagePreview(path) {
            if (path.startsWith('MERMAID_CODE:')) {
                const code = extractMermaidCode(path).substring(0, 100);
                return `<div class="text-gray-400 text-xs text-center p-2 font-mono">${code}...</div>`;
            }
            return `<img src="${path}" alt="å€™é€‰å›¾" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'text-red-400 text-xs\\'>åŠ è½½å¤±è´¥</div>'">`;
        }

        async function selectCandidate(positionIndex, candidateIndex) {
            selections[positionIndex] = candidateIndex;

            // æ›´æ–° UI
            const pos = candidates.find(p => p.index === positionIndex);
            if (pos) {
                const selectedCand = pos.candidates[candidateIndex];
                if (selectedCand) {
                    // æ›´æ–° Markdown ä¸­çš„å›¾ç‰‡å¼•ç”¨
                    await updateMarkdownImage(positionIndex, selectedCand);
                }
            }

            // é‡æ–°æ¸²æŸ“
            showCandidates(positionIndex);
            updateCounts();
        }

        async function updateMarkdownImage(positionIndex, candidate) {
            const pos = candidates.find(p => p.index === positionIndex);
            if (!pos) return;

            // æ„å»ºæ–°çš„å›¾ç‰‡è¡Œ
            const newLine = `![${candidate.alt_text}](${candidate.path}) â­`;

            // æ›´æ–° markdownContent
            const lines = markdownContent.split('\n');

            // æ‰¾åˆ°å¹¶æ›´æ–°å¯¹åº”çš„å›¾ç‰‡è¡Œ
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.includes(candidate.path) || line.includes(pos.candidates[0].path)) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è¿™ä¸ªä½ç½®çš„å›¾ç‰‡
                    const isPositionMatch = pos.candidates.some(c => line.includes(c.path));
                    if (isPositionMatch && !line.trim().startsWith('<!--')) {
                        lines[i] = newLine;

                        // æ³¨é‡Šæ‰å…¶ä»–å€™é€‰å›¾
                        for (let j = i - 5; j <= i + 10; j++) {
                            if (j >= 0 && j < lines.length && j !== i) {
                                for (let c of pos.candidates) {
                                    if (c.index !== candidate.index && lines[j].includes(c.path) && !lines[j].trim().startsWith('<!--')) {
                                        lines[j] = `<!-- å€™é€‰${c.index + 1}: ![${c.alt_text}](${c.path}) -->`;
                                    }
                                }
                            }
                        }
                        break;
                    }
                }
            }

            markdownContent = lines.join('\n');
            document.getElementById('markdown-editor').value = markdownContent;
            renderMarkdown();

            // ä¿å­˜åˆ°æœåŠ¡å™¨
            try {
                await fetch('/api/update-image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        position: positionIndex,
                        candidate: candidate.index
                    })
                });
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
            }
        }

        function renderAllCandidates() {
            const container = document.getElementById('all-candidates-container');
            let html = '';

            candidates.forEach(pos => {
                html += `
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-300 mb-2">ä½ç½® ${pos.index + 1}: ${getTypeName(pos.image_type)}</h3>
                        ${pos.prompt ? `<p class="text-xs text-gray-400 mb-3">${pos.prompt.substring(0, 100)}...</p>` : ''}
                        <div class="grid grid-cols-3 gap-3">
                `;

                pos.candidates.forEach((cand, idx) => {
                    const isSelected = selections[pos.index] === idx;
                    html += `
                        <div
                            class="candidate-card rounded-lg overflow-hidden bg-gray-700 ${isSelected ? 'selected' : ''}"
                            onclick="selectCandidate(${pos.index}, ${idx})"
                        >
                            <div class="aspect-square bg-gray-600 flex items-center justify-center p-2">
                                ${getImagePreview(cand.path)}
                            </div>
                            <div class="p-2 text-center text-xs">
                                <span class="text-gray-400">å€™é€‰ ${idx + 1}</span>
                                ${isSelected ? '<span class="ml-2 text-blue-400">âœ“</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            container.innerHTML = html || '<p class="text-gray-400">æ²¡æœ‰æ‰¾åˆ°å€™é€‰å›¾</p>';
        }

        function switchTab(tab) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.mode-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            // æ˜¾ç¤ºé€‰ä¸­å†…å®¹
            document.getElementById(`${tab}-mode`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');

            if (tab === 'candidates') {
                renderAllCandidates();
            }
        }

        function onEditorChange() {
            markdownContent = document.getElementById('markdown-editor').value;
        }

        async function saveContent() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ä¿å­˜ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/save-markdown', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content: markdownContent })
                });

                const data = await response.json();
                if (data.success) {
                    originalContent = markdownContent;
                    showSaveStatus();
                    // ä¿å­˜æˆåŠŸååˆ·æ–°é¢„è§ˆ
                    renderMarkdown();
                } else {
                    showError('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                showError('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function selectAllBest() {
            if (!confirm('ç¡®å®šè¦ä¸ºæ‰€æœ‰ä½ç½®é€‰æ‹©ç¬¬ä¸€å¼ å€™é€‰å›¾å—ï¼Ÿ')) return;

            for (let pos of candidates) {
                if (pos.candidates.length > 0) {
                    await selectCandidate(pos.index, 0);
                }
            }
        }

        function updateCounts() {
            document.getElementById('selected-count').textContent = Object.keys(selections).length;
            document.getElementById('total-count').textContent = candidates.length;
        }

        function getTypeName(type) {
            const names = {
                'cover': 'å°é¢å›¾',
                'section': 'ç« èŠ‚é…å›¾',
                'concept': 'æ¦‚å¿µç¤ºæ„å›¾',
                'atmospheric': 'æ°›å›´æ’å›¾',
                'diagram': 'æ¶æ„å›¾',
                'code_concept': 'ä»£ç ç»“æ„å›¾'
            };
            return names[type] || type;
        }

        function showSaveStatus() {
            const status = document.getElementById('save-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
        }

        function showError(message) {
            alert('é”™è¯¯: ' + message);
        }

        function exportMarkdown() {
            // è·å–å½“å‰ markdown å†…å®¹
            const content = markdownContent || document.getElementById('markdown-editor').value;

            // åˆ›å»º Blob å¯¹è±¡
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;

            // ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶å
            const filePath = document.getElementById('file-info').textContent;
            let fileName = 'export.md';
            if (filePath && filePath !== 'åŠ è½½ä¸­...') {
                const pathParts = filePath.split('/');
                const originalName = pathParts[pathParts.length - 1];
                // å¦‚æœåŸæ–‡ä»¶æœ‰æ‰©å±•åï¼Œå»æ‰å®ƒ
                if (originalName.includes('.')) {
                    fileName = originalName.replace(/\.[^.]+$/, '') + '.md';
                } else {
                    fileName = originalName + '.md';
                }
            }

            link.download = fileName;

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();

            // æ¸…ç†
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            console.log(`å·²å¯¼å‡º: ${fileName}`);
        }

        async function illustrateMarkdown() {
            const btn = document.getElementById('illustrate-btn');
            const originalText = btn.textContent;
            const originalClass = btn.className;

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.textContent = 'é…å›¾ä¸­...';
            btn.disabled = true;
            btn.className = 'px-4 py-2 bg-gray-600 rounded-lg text-sm cursor-not-allowed';

            try {
                // è·å–å½“å‰é¡µé¢æ˜¾ç¤ºçš„ markdown å†…å®¹ï¼ˆä¼˜å…ˆä½¿ç”¨ markdownContentï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¼–è¾‘å™¨å€¼ï¼‰
                const content = markdownContent || document.getElementById('markdown-editor').value;

                if (!content || !content.trim()) {
                    showError('é¡µé¢å†…å®¹ä¸ºç©º');
                    return;
                }

                // ç¡®è®¤æ˜¯å¦å¼€å§‹é…å›¾
                if (!confirm('å³å°†ä¸ºå½“å‰ Markdown å†…å®¹é…å›¾ï¼Œè¿™å°†æ›¿æ¢é¡µé¢å†…å®¹ã€‚\né…å›¾å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    return;
                }

                console.log('å¼€å§‹é…å›¾...');
                console.log('é…å›¾å†…å®¹é•¿åº¦:', content.length);

                // è·å–é€‰æ‹©çš„å›¾ç‰‡æ¥æº
                const imageSource = document.getElementById('image-source-select').value;
                console.log('å›¾ç‰‡æ¥æº:', imageSource);

                // è°ƒç”¨åç«¯ API
                const response = await fetch('/api/illustrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        imageSource: imageSource,
                        batch: 1
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ›´æ–°å…¨å±€å’Œç¼–è¾‘å™¨å†…å®¹
                    markdownContent = data.content;
                    originalContent = data.content;
                    document.getElementById('markdown-editor').value = data.content;
                    document.getElementById('file-info').textContent = data.path;

                    // é‡æ–°åŠ è½½å€™é€‰å›¾æ•°æ®
                    await loadCandidates();

                    // åˆ·æ–°é¢„è§ˆæ˜¾ç¤º
                    renderMarkdown();

                    showSaveStatus();
                    alert(`é…å›¾æˆåŠŸï¼\nç”Ÿæˆäº† ${data.images_generated} å¼ å›¾ç‰‡\nå…± ${candidates.length} ä¸ªé…å›¾ä½ç½®`);
                } else {
                    showError(data.error || 'é…å›¾å¤±è´¥');
                }

            } catch (error) {
                console.error('é…å›¾é”™è¯¯:', error);
                showError('é…å›¾å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.textContent = originalText;
                btn.disabled = false;
                btn.className = originalClass;
            }
        }

        // å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveContent();
                }
            }
        });

        // å¸®åŠ©æ¨¡æ€æ¡†æ§åˆ¶
        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('help-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="help-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 z-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-gray-800 text-gray-100">
            <!-- å…³é—­æŒ‰é’® -->
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-blue-400">ğŸ“– ä½¿ç”¨å¸®åŠ©</h3>
                <button onclick="toggleHelp()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- å¸®åŠ©å†…å®¹ -->
            <div class="space-y-6 max-h-96 overflow-y-auto pr-2">
                <!-- å¿«é€Ÿå¼€å§‹ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸš€ å¿«é€Ÿå¼€å§‹</h4>
                    <div class="bg-gray-900 p-4 rounded text-sm">
                        <ol class="list-decimal list-inside space-y-2">
                            <li><strong>ç²˜è´´ Markdown å†…å®¹</strong>ï¼šåˆ‡æ¢åˆ°"ç¼–è¾‘æ¨¡å¼"ï¼Œç²˜è´´ä½ çš„æ–‡ç« </li>
                            <li><strong>é€‰æ‹©å›¾ç‰‡æ¥æº</strong>ï¼šåœ¨å·¦ä¸Šè§’é€‰æ‹©å›¾ç‰‡æ¥æº
                                <ul class="list-disc list-inside ml-6 mt-1 text-gray-400">
                                    <li><code class="text-yellow-400">auto</code> - æ™ºèƒ½é€‰æ‹©ï¼ˆæ¨èï¼‰</li>
                                    <li><code class="text-yellow-400">mermaid</code> - æŠ€æœ¯å›¾è¡¨ï¼ˆå…è´¹ï¼‰</li>
                                    <li><code class="text-yellow-400">unsplash</code> - å…è´¹å›¾åº“</li>
                                    <li><code class="text-yellow-400">zhipu/doubao/flux</code> - AI ç”Ÿæˆ</li>
                                </ul>
                            </li>
                            <li><strong>ç‚¹å‡»"å¼€å§‹é…å›¾"</strong>ï¼šç­‰å¾…é…å›¾å®Œæˆ</li>
                            <li><strong>æŸ¥çœ‹ç»“æœ</strong>ï¼šåœ¨"é¢„è§ˆæ¨¡å¼"æŸ¥çœ‹æ•ˆæœ</li>
                            <li><strong>å¯¼å‡ºæ–‡ä»¶</strong>ï¼šç‚¹å‡»"å¯¼å‡º Markdown"ä¸‹è½½</li>
                        </ol>
                    </div>
                </section>

                <!-- å›¾ç‰‡æ¥æºè¯´æ˜ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸ¨ å›¾ç‰‡æ¥æºè¯´æ˜</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-green-400">auto - æ™ºèƒ½é€‰æ‹©</span>
                            <p class="text-gray-400 mt-1">æŠ€æœ¯æ–‡æ¡£ç”¨ Mermaidï¼Œæ™®é€šæ–‡æ¡£ç”¨å›¾åº“ï¼Œå°é¢å›¾ç”¨ AI</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-blue-400">mermaid - æŠ€æœ¯å›¾è¡¨</span>
                            <p class="text-gray-400 mt-1">æµç¨‹å›¾ã€åºåˆ—å›¾ç­‰ï¼Œå®Œå…¨å…è´¹</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-purple-400">unsplash - å…è´¹å›¾åº“</span>
                            <p class="text-gray-400 mt-1">é«˜è´¨é‡çœŸå®ç…§ç‰‡</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-orange-400">zhipu - æ™ºè°±AI</span>
                            <p class="text-gray-400 mt-1">ä¸­æ–‡æ•ˆæœå¥½ï¼Œ0.06å…ƒ/å¼ </p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-pink-400">doubao - è±†åŒ…</span>
                            <p class="text-gray-400 mt-1">ä»·æ ¼ä¾¿å®œï¼Œ0.005å…ƒ/å¼ </p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <span class="font-semibold text-red-400">flux - Flux.1</span>
                            <p class="text-gray-400 mt-1">è´¨é‡æœ€é«˜ï¼Œ0.01å…ƒ/å¼ </p>
                        </div>
                    </div>
                </section>

                <!-- ç•Œé¢åŠŸèƒ½ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸ–¥ï¸ ç•Œé¢åŠŸèƒ½</h4>
                    <div class="bg-gray-900 p-4 rounded text-sm">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-2">æ¨¡å¼</th>
                                    <th class="text-left py-2">åŠŸèƒ½</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-300">
                                <tr class="border-b border-gray-800">
                                    <td class="py-2 font-semibold">é¢„è§ˆæ¨¡å¼</td>
                                    <td class="py-2">æŸ¥çœ‹ Markdown æ¸²æŸ“æ•ˆæœï¼Œæ”¯æŒ Mermaid å›¾è¡¨</td>
                                </tr>
                                <tr class="border-b border-gray-800">
                                    <td class="py-2 font-semibold">ç¼–è¾‘æ¨¡å¼</td>
                                    <td class="py-2">åœ¨çº¿ç¼–è¾‘å†…å®¹ï¼Œç²˜è´´æ–°æ–‡ç« </td>
                                </tr>
                                <tr>
                                    <td class="py-2 font-semibold">å€™é€‰å›¾ç®¡ç†</td>
                                    <td class="py-2">æŸ¥çœ‹æ‰€æœ‰é…å›¾ä½ç½®ï¼Œé€‰æ‹©æœ€æ»¡æ„çš„å€™é€‰å›¾</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- æŒ‰é’®è¯´æ˜ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸ”˜ æŒ‰é’®è¯´æ˜</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-orange-600 rounded text-xs">å¼€å§‹é…å›¾</span>
                            <span class="text-gray-400">ä¸ºå½“å‰å†…å®¹ç”Ÿæˆé…å›¾</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-green-600 rounded text-xs">å…¨é€‰ç¬¬ä¸€å¼ </span>
                            <span class="text-gray-400">ä¸ºæ‰€æœ‰ä½ç½®é€‰æ‹©ç¬¬ä¸€å¼ å€™é€‰å›¾</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-blue-600 rounded text-xs">ä¿å­˜ä¿®æ”¹</span>
                            <span class="text-gray-400">ä¿å­˜é€‰æ‹©åˆ°åŸæ–‡ä»¶</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-purple-600 rounded text-xs">å¯¼å‡º Markdown</span>
                            <span class="text-gray-400">ä¸‹è½½ Markdown æ–‡ä»¶</span>
                        </div>
                    </div>
                </section>

                <!-- é…å›¾è§„åˆ™ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">ğŸ“‹ é…å›¾è§„åˆ™</h4>
                    <div class="bg-gray-900 p-4 rounded text-sm text-gray-300">
                        <ul class="space-y-1">
                            <li>âœ… H1 æ ‡é¢˜å â†’ å°é¢å›¾</li>
                            <li>âœ… H2 æ ‡é¢˜å â†’ ç« èŠ‚é…å›¾ï¼ˆå†…å®¹ > 100 å­—ï¼‰</li>
                            <li>âœ… é•¿æ®µè½ â†’ æ°›å›´å›¾ï¼ˆæ®µè½ >= 150 å­—ï¼‰</li>
                            <li>âš ï¸ æœ€å°é—´éš”ï¼š3 ä¸ªæ®µè½</li>
                            <li>âš ï¸ æœ€å¤§æ•°é‡ï¼š10 å¼ /ç¯‡</li>
                        </ul>
                    </div>
                </section>

                <!-- å¿«æ·é”® -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">âŒ¨ï¸ å¿«æ·é”®</h4>
                    <div class="bg-gray-900 p-4 rounded text-sm text-gray-300">
                        <p><kbd class="px-2 py-1 bg-gray-700 rounded">Ctrl/Cmd + S</kbd> - ä¿å­˜ä¿®æ”¹</p>
                    </div>
                </section>

                <!-- å¸¸è§é—®é¢˜ -->
                <section>
                    <h4 class="text-lg font-semibold text-blue-300 mb-2">â“ å¸¸è§é—®é¢˜</h4>
                    <div class="space-y-3 text-sm">
                        <div class="bg-gray-900 p-3 rounded">
                            <p class="font-semibold text-yellow-400">Q: ä¸ºä»€ä¹ˆæœ‰äº›æ ‡é¢˜åæ²¡æœ‰é…å›¾ï¼Ÿ</p>
                            <p class="text-gray-400 mt-1">A: æ™ºèƒ½æ¨¡å¼ä¸‹ï¼Œåªæœ‰åç»­å†…å®¹è¶…è¿‡ 100 å­—çš„ H2 æ ‡é¢˜æ‰ä¼šé…å›¾ï¼Œé¿å…è¿‡åº¦é…å›¾ã€‚</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <p class="font-semibold text-yellow-400">Q: Mermaid å›¾è¡¨ä¸æ˜¾ç¤ºæ€ä¹ˆåŠï¼Ÿ</p>
                            <p class="text-gray-400 mt-1">A: åœ¨ GitHubã€GitLab ç­‰å¹³å°æŸ¥çœ‹ï¼Œæˆ–ä½¿ç”¨æ”¯æŒ Mermaid çš„ Markdown ç¼–è¾‘å™¨ã€‚</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded">
                            <p class="font-semibold text-yellow-400">Q: å¦‚ä½•åªé‡æ–°ç”ŸæˆæŸå¼ å›¾ï¼Ÿ</p>
                            <p class="text-gray-400 mt-1">A: ä½¿ç”¨å‘½ä»¤è¡Œçš„å¢é‡æ›´æ–°åŠŸèƒ½ï¼Œæˆ–åœ¨ç¼–è¾‘æ¨¡å¼åˆ é™¤è¯¥å›¾ç‰‡åé‡æ–°é…å›¾ã€‚</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- åº•éƒ¨æŒ‰é’® -->
            <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                <button onclick="toggleHelp()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    çŸ¥é“äº†
                </button>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="mt-12 py-6 border-t border-gray-800">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- å·¦ä¾§ï¼šé¡¹ç›®ä¿¡æ¯ -->
                <div class="text-center md:text-left">
                    <p class="text-gray-500 text-sm">
                        Markdown Illustrator - Markdown è‡ªåŠ¨é…å›¾ç³»ç»Ÿ
                    </p>
                    <p class="text-gray-600 text-xs mt-1">
                        æ”¯æŒ 8 ç§å›¾ç‰‡æ¥æº | æ™ºèƒ½é…å›¾ | Web äº¤äº’ç•Œé¢
                    </p>
                </div>

                <!-- ä¸­é—´ï¼šé“¾æ¥ -->
                <div class="flex gap-4 text-sm">
                    <a href="https://github.com" target="_blank" class="text-gray-500 hover:text-blue-400 transition">
                        GitHub
                    </a>
                    <a href="/docs/USER_GUIDE.md" target="_blank" class="text-gray-500 hover:text-blue-400 transition">
                        ä½¿ç”¨æŒ‡å—
                    </a>
                    <a href="https://github.com" target="_blank" class="text-gray-500 hover:text-blue-400 transition">
                        æ–‡æ¡£
                    </a>
                </div>

                <!-- å³ä¾§ï¼šå¤‡æ¡ˆä¿¡æ¯ -->
                <div class="text-center md:text-right">
                    <p class="text-gray-600 text-xs">
                        Â© 2025 Markdown Illustrator
                    </p>
                    <p class="text-gray-700 text-xs mt-1">
                        <a href="https://beian.miit.gov.cn/" target="_blank" class="hover:text-gray-500 transition">
                            å¤‡æ¡ˆå·ï¼šäº¬ICPå¤‡XXXXXXXXå·-X
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
